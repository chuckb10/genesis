<h1>Genethis</h1>
<div style='width: 800px;'>
  <div id="gmap" style="width: 99%; height: 370px; border: 1px solid Gray;"></div>
    緯度：<span id="lat"></span><br />
    経度：<span id="lng"></span><br />
    半径：<span><% if !params[:r].blank? %><%= params[:r] %><% else %>3000<% end %></span><br />
    <div id="get_feed">

    <% if !params[:r].blank? %>
      <% r = params[:r] %>
    <% else %>
      <% r = '3000' %>
    <% end %>
    <%= link_to "Feed Get", "/feed?lat=35.69013656061955&lng=139.70042914152145&r=" + r %>
    </div>
</div>

<!-- ベタ書きです -->
<script type="text/javascript">
    var mapStyle = [
      //omitted for brevity but find nice one here: http://snazzymaps.com/
    {
        "featureType": "all",
        "elementType": "labels.text.fill",
        "stylers": [
            {
                "saturation": 36
            },
            {
                "color": "#000000"
            },
            {
                "lightness": 40
            }
        ]
    },
    {
        "featureType": "all",
        "elementType": "labels.text.stroke",
        "stylers": [
            {
                "visibility": "on"
            },
            {
                "color": "#000000"
            },
            {
                "lightness": 16
            }
        ]
    },
    {
        "featureType": "all",
        "elementType": "labels.icon",
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "administrative",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 20
            }
        ]
    },
    {
        "featureType": "administrative",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 17
            },
            {
                "weight": 1.2
            }
        ]
    },
    {
        "featureType": "landscape",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 20
            }
        ]
    },
    {
        "featureType": "poi",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 21
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "geometry.fill",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 17
            }
        ]
    },
    {
        "featureType": "road.highway",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 29
            },
            {
                "weight": 0.2
            }
        ]
    },
    {
        "featureType": "road.arterial",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 18
            }
        ]
    },
    {
        "featureType": "road.local",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 16
            }
        ]
    },
    {
        "featureType": "transit",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#000000"
            },
            {
                "lightness": 19
            }
        ]
    },
    {
        "featureType": "water",
        "elementType": "geometry",
        "stylers": [
            {
                "color": "#0f252e"
            },
            {
                "lightness": 17
            }
        ]
    }
    ];

    google.maps.event.addDomListener(window, 'load', function(){
      var markerObj;
      var circleObj;
      var mapObj;
      var lng = 139.70042914152145;
      var lat = 35.69013656061955;
      var latlng = new google.maps.LatLng(lat, lng);
      var r = <% if !params[:r].blank? %><%= params[:r] %><% else %>3000<% end %>;
      var mapOptions = {
          zoom: 12,
          center: latlng,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          styles: mapStyle,
          scaleControl: true
      };


      mapObj = new google.maps.Map($("#gmap")[0], mapOptions);

      // 丸を設定 
      circleObj = new google.maps.Circle({
        center: latlng,
        clickable: true,
        radius: r,
        strokeWeight: 3,
        strokeColor: "#000055",
        strokeOpacity: 0.5,
        fillColor: "#0055ff",
        fillOpacity: 0.5,
        map: mapObj
      }); 

      markerObj = new google.maps.Marker({
          position: latlng,
          draggable: true,
          title: "ドラッグも出来ます",
          map: mapObj
      });
 
      // マップクリックイベントを追加
      google.maps.event.addListener(mapObj, 'click', function(e)
      {
          // ポジションを変更
          markerObj.position = e.latLng;
 
          // マーカーをセット
          markerObj.setMap(mapObj);
          circleObj.bindTo('center', markerObj, 'position');
          circleObj.setMap(mapObj); 
          $("#lat").text(e.latLng.lat());
          $("#lng").text(e.latLng.lng());
          var url = "/feed?lat=" + e.latLng.lat() + "&lng=" + e.latLng.lng() + "&r=" + r;
          $("#get_feed a").attr("href", url);
      });

      // マーカードラッグ中のイベントを追加
      google.maps.event.addListener(markerObj, 'drag', function(e)
      {
          $("#lat").text(e.latLng.lat());
          $("#lng").text(e.latLng.lng());
          var url = "/feed?lat=" + e.latLng.lat() + "&lng=" + e.latLng.lng() + "&r=" + r;
          $("#get_feed a").attr("href", url);
      });
    });
</script>
